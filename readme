This demo shows how to create CHT mesh using Gmsh, and convert to Nek5000 mesh using gmsh2nek.
It also demonstrate how to set boundary tag in usr file in Nek5000.

Step 1. Create CHT mesh in Gmsh

In order to make fluid and solid mesh conformal, it is suggested to make fluid mesh and solid mesh in one .geo file.
Please check the tubebe_cht.geo file.

When dumping fluid mesh, do not assign any physical surface or volume for solid mesh. 
And do the vice versa for exporting solid mesh. 

At the end of tube_cht.geo file, when exporting fluid mesh.
======================================================
// define and dump fluid mesh
Physical Surface("inlet",1) = {1,2,3,4,5} ;
Physical Surface("outlet",2) = {42,64,86,108,130};
Physical Surface("wall", 3) = {59,81,103,125};
Physical Volume("fluid",4) = {1,2,3,4,5};

/*
// define and dump shell (solid) mesh
Physical Surface("innerWall", 1) = {59,81,103,125};
Physical Surface("end", 2) = {6,7,8,9,152,174,196,218};
Physical Surface("outerWall", 3) = {165,143,187,209};
Physical Volume("solid",4) = {6,7,8,9};
*/
======================================================



when exporting solid mesh.
======================================================
/*
// define and dump fluid mesh
Physical Surface("inlet",1) = {1,2,3,4,5} ;
Physical Surface("outlet",2) = {42,64,86,108,130};
Physical Surface("wall", 3) = {59,81,103,125};
Physical Volume("fluid",4) = {1,2,3,4,5};
*/

// define and dump shell (solid) mesh
Physical Surface("innerWall", 1) = {59,81,103,125};
Physical Surface("end", 2) = {6,7,8,9,152,174,196,218};
Physical Surface("outerWall", 3) = {165,143,187,209};
Physical Volume("solid",4) = {6,7,8,9};
======================================================


Step 2. Convert in gmsh2nek

Assume you have successfully exported fluid.msh and shell.msh file from tubebe_cht.geo using Gmsh.
The following part shows the conversion step in gmsh2nek.

======================================================
hyuan@compute-240-10:~/exo2nek_github_fix$  gmsh2nek
Enter mesh dimension: 3                              <- enter mesh dimension (2 or 3)
Input fluid .msh file name: fluid                    <- enter fluid mesh file name without .msh
 reading mesh file fluid.msh
 total node number is        59737
 total quad element number is         1274
 total hex element number is         7140
 total fluid hex number:         7140
Do you have solid mesh ? (0 for no, 1 for yes) 1     <- enter if you have solid mesh (0 for no, 1 for yes)
Input solid .msh file name: shell                    <- enter solid mesh file name without .msh
 reading mesh file shell.msh
 total node number is        25256
 total quad element number is         1400
 total hex element number is         2800
 total hex number:         9940
 reading mesh file fluid.msh
 ******************************************************
 Fluid mesh boundary info summary
 BoundaryName     BoundaryID
 inlet           1
 outlet           2
 wall           3
 ******************************************************
 reading mesh file shell.msh
 ******************************************************
 Solid mesh boundary info summary
 BoundaryName     BoundaryID
 innerWall           1
 end           2
 outerWall           3
 ******************************************************
 For Fluid domain
 Enter number of periodic boundary surface pairs:     <- enter fluid mesh periodicity, 0 means no periodicity, 1 for one pair of periodicity, etc
0
 For Solid domain
 Enter number of periodic boundary surface pairs:     <- enter solid mesh periodicity, 0 means no periodicity, 1 for one pair of periodicity, etc
0
 please give re2 file name:                           <- enter output .re2 file name
tube_cht

writing tube_cht.re2
 velocity boundary faces:         1274
 thermal boundary faces:         2674
======================================================

Step 3. Run genmap or gencon to create map file or connecivity file. 

Step 4. Setup boundary tags in Nek5000 in usrdat2()


for velocity bc

      do iel=1,nelv
      do ifc=1,2*ndim
        id_face = bc(5,ifc,iel,1)
        if (id_face.eq.1) then        ! surface 1 for inlet 
           cbc(ifc,iel,1) = 'v  '
        elseif (id_face.eq.2) then    ! surface 2 for outlet
           cbc(ifc,iel,1) = 'O  '
        elseif (id_face.eq.3) then    ! surface 3 for wall
           cbc(ifc,iel,1) = 'W  '
        endif
      enddo
      enddo

for thermal bc

      do iel=1,nelt
      eg = lglel(iel)                 ! get global element number
      do ifc=1,2*ndim
        id_face = bc(5,ifc,iel,2)
        if (eg.le.nelgv) then           ! for fluid domain
          if (id_face.eq.1) then        ! surface 1 for inlet 
             cbc(ifc,iel,2) = 't  '
          elseif (id_face.eq.2) then    ! surface 2 for outlet
             cbc(ifc,iel,2) = 'O  '
          elseif (id_face.eq.3) then    ! surface 3 for wall, which connects to solid domain
             cbc(ifc,iel,2) = 'E  '
          endif
        else                            ! for solid domain
          if (id_face.eq.1) then        ! surface 1 for inner wall, which connects to fluid domain
             cbc(ifc,iel,2) = 'E  '
          elseif (id_face.eq.2) then    ! surface 2 for shell end
             cbc(ifc,iel,2) = 'I  '
          elseif (id_face.eq.3) then    ! surface 3 for shell exterior surface
             cbc(ifc,iel,2) = 'f  '
          endif
        
        endif
      enddo
      enddo
